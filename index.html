<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Copyweriter Marketing</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Lora:ital,wght@0,600;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F7F5F2;
    --surface: #FFFFFF;
    --surface2: #F0EDE8;
    --border: #E2DDD8;
    --text: #1C1917;
    --text-secondary: #78716C;
    --accent: #7C2D12;
    --accent-light: #FEF2EE;
    --accent-mid: #C2410C;
    --gold: #92400E;
    --green: #15803D;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
  }

  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 1.25rem 2rem;
    display: flex;
    align-items: baseline;
    gap: 1rem;
  }

  .logo {
    font-family: 'Lora', serif;
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--accent);
  }

  .logo-sub {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 400;
  }

  .container {
    max-width: 860px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  .section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem 1.5rem;
    margin-bottom: 0.75rem;
  }

  .section-label {
    font-size: 0.68rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.9rem;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  label {
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  input, textarea {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-size: 0.87rem;
    padding: 0.6rem 0.8rem;
    transition: border-color 0.15s, box-shadow 0.15s;
    outline: none;
    width: 100%;
  }

  input:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124,45,18,0.08);
    background: var(--surface);
  }

  textarea { resize: vertical; min-height: 80px; line-height: 1.5; }

  .api-note {
    font-size: 0.7rem;
    color: var(--text-secondary);
    margin-top: 0.4rem;
  }

  .lang-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 0.4rem;
  }

  .lang-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-secondary);
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.5rem 0.3rem;
    text-align: center;
    transition: all 0.15s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.2rem;
  }

  .lang-btn .flag { font-size: 1rem; }

  .lang-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-light);
  }

  .lang-btn.active {
    border-color: var(--accent);
    background: var(--accent-light);
    color: var(--accent);
    font-weight: 600;
  }

  .generate-btn {
    background: var(--accent);
    border: none;
    border-radius: 7px;
    color: #fff;
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 0.8rem 2rem;
    width: 100%;
    transition: background 0.15s, transform 0.1s;
    text-transform: uppercase;
  }

  .generate-btn:hover { background: var(--accent-mid); transform: translateY(-1px); }
  .generate-btn:active { transform: translateY(0); }
  .generate-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .loading {
    display: none;
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
    font-size: 0.85rem;
  }

  .loading.visible { display: block; }

  .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 0.7rem;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .error-msg {
    display: none;
    background: #FEF2F2;
    border: 1px solid #FECACA;
    border-radius: 6px;
    color: #B91C1C;
    font-size: 0.8rem;
    padding: 0.7rem 0.9rem;
    margin-top: 0.6rem;
  }

  .error-msg.visible { display: block; }

  .results { display: none; margin-top: 1.5rem; }
  .results.visible { display: block; }

  .results-header {
    font-size: 0.68rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.75rem;
  }

  .result-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 0.75rem;
  }

  .result-block-title {
    background: var(--surface2);
    border-bottom: 1px solid var(--border);
    padding: 0.45rem 1rem;
    font-size: 0.66rem;
    font-weight: 600;
    color: var(--gold);
    text-transform: uppercase;
    letter-spacing: 0.12em;
  }

  .result-row {
    display: flex;
    align-items: stretch;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }

  .result-row:last-child { border-bottom: none; }
  .result-row:hover { background: var(--accent-light); }

  .result-row-label {
    font-size: 0.66rem;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    white-space: nowrap;
    padding: 0.7rem 1rem;
    min-width: 145px;
    border-right: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    padding-top: 0.75rem;
  }

  .result-row-value {
    font-size: 0.87rem;
    line-height: 1.6;
    color: var(--text);
    flex: 1;
    padding: 0.7rem 1rem;
    word-break: break-word;
    white-space: pre-wrap;
  }

  .char-count {
    font-size: 0.66rem;
    color: var(--text-secondary);
    margin-left: 0.4rem;
    font-weight: 400;
  }

  .char-count.over { color: #B91C1C; }

  .copy-btn {
    background: transparent;
    border: none;
    border-left: 1px solid var(--border);
    color: var(--text-secondary);
    cursor: pointer;
    font-family: 'Inter', sans-serif;
    font-size: 0.7rem;
    font-weight: 500;
    padding: 0 0.9rem;
    white-space: nowrap;
    transition: color 0.12s, background 0.12s;
    min-width: 60px;
    text-align: center;
  }

  .copy-btn:hover { color: var(--accent); background: var(--accent-light); }
  .copy-btn.copied { color: var(--green); }

  @media (max-width: 600px) {
    .form-grid { grid-template-columns: 1fr; }
    .lang-grid { grid-template-columns: repeat(3, 1fr); }
    .result-row-label { min-width: 90px; font-size: 0.6rem; }
    header { flex-direction: column; gap: 0.1rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">Wine Copy Generator</div>
  <div class="logo-sub">Email &amp; Landing Page â€” Powered by Claude AI</div>
</header>

<div class="container">

  <div class="section">
    <div class="section-label">API Key</div>
    <div class="form-group">
      <label>Anthropic API Key</label>
      <input type="password" id="apiKey" placeholder="sk-ant-api03-..." autocomplete="off">
    </div>
    <div class="api-note">La chiave non viene salvata. Inseriscila ogni volta che usi il tool.</div>
  </div>

  <div class="section">
    <div class="section-label">Lingua</div>
    <div class="lang-grid">
      <button class="lang-btn active" data-lang="it" onclick="selectLang(this)"><span class="flag">ðŸ‡®ðŸ‡¹</span>Italiano</button>
      <button class="lang-btn" data-lang="en" onclick="selectLang(this)"><span class="flag">ðŸ‡¬ðŸ‡§</span>English</button>
      <button class="lang-btn" data-lang="de" onclick="selectLang(this)"><span class="flag">ðŸ‡©ðŸ‡ª</span>Deutsch</button>
      <button class="lang-btn" data-lang="fr" onclick="selectLang(this)"><span class="flag">ðŸ‡«ðŸ‡·</span>FranÃ§ais</button>
      <button class="lang-btn" data-lang="nl" onclick="selectLang(this)"><span class="flag">ðŸ‡³ðŸ‡±</span>Nederlands</button>
      <button class="lang-btn" data-lang="nl-be" onclick="selectLang(this)"><span class="flag">ðŸ‡§ðŸ‡ª</span>Vlaams</button>
    </div>
  </div>

  <div class="section">
    <div class="section-label">Input</div>
    <div class="form-grid">
      <div class="form-group">
        <label>Topic Creativo</label>
        <textarea id="creativeTopic" placeholder="Es: L'estate che arriva â€” il sole, il mare, una bottiglia fresca in mano..." rows="4"></textarea>
      </div>
      <div class="form-group">
        <label>Offerta Commerciale</label>
        <textarea id="commercialOffer" placeholder="Es: 3 bottiglie di Vermentino di Sardegna a 29,90â‚¬ (sconto 30%) â€” spedizione gratis" rows="4"></textarea>
      </div>
    </div>
  </div>

  <button class="generate-btn" id="generateBtn" onclick="generate()">Genera i testi</button>
  <div class="error-msg" id="errorMsg"></div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    Generazione in corso...
  </div>

  <div class="results" id="results">
    <div class="results-header">Testi generati</div>
    <div id="resultsGrid"></div>
  </div>

</div>

<script>
let selectedLang = 'it';

function selectLang(btn) {
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selectedLang = btn.dataset.lang;
}

const langNames = {
  'it': 'italiano',
  'en': 'British English',
  'de': 'tedesco (Germania)',
  'fr': 'francese (Francia)',
  'nl': 'olandese (Paesi Bassi)',
  'nl-be': 'fiammingo belga (Belgio)'
};

const fieldLabels = {
  oggetto: 'Oggetto',
  oggettoAlternativo: 'Oggetto alt.',
  preview: 'Preview',
  previewAlternativa: 'Preview alt.',
  bodyEmail: 'Body email',
  cta: 'CTA',
  ctaAlternativa: 'CTA alternativa',
  titoloLanding: 'Titolo landing',
  bodyLanding: 'Body landing'
};

const sectionGroups = {
  'Email': ['oggetto','oggettoAlternativo','preview','previewAlternativa','bodyEmail','cta','ctaAlternativa'],
  'Landing Page': ['titoloLanding','bodyLanding']
};

const charLimits = {
  oggetto: 64, oggettoAlternativo: 64, preview: 64, previewAlternativa: 64, bodyEmail: 300, titoloLanding: 64
};

async function generate() {
  const apiKey = document.getElementById('apiKey').value.trim();
  const topic = document.getElementById('creativeTopic').value.trim();
  const offer = document.getElementById('commercialOffer').value.trim();
  const errEl = document.getElementById('errorMsg');

  errEl.classList.remove('visible');

  if (!apiKey) { showError('Inserisci la tua API key Anthropic.'); return; }
  if (!topic) { showError('Inserisci un topic creativo.'); return; }
  if (!offer) { showError("Inserisci l'offerta commerciale."); return; }

  setLoading(true);

  const lang = langNames[selectedLang];

  const prompt = `Sei il copywriter di un ecommerce di vino italiano. Genera testi per email marketing e landing page in ${lang}.

BUYER PERSONA: uomo, circa 40 anni, licenza superiore, vive in cittÃ , appassionato di vino ma non esperto, molto attento al prezzo e alle offerte, pratico e diretto.

TONO DI VOCE: diretto, amichevole, familiare, rassicurante, leggermente pushy. Come un amico che ti segnala l'affare del momento. Niente fronzoli, va al sodo.

TOPIC CREATIVO: ${topic}

OFFERTA COMMERCIALE (riporta sempre i dati esatti â€” prezzi, sconti, prodotti, quantitÃ , condizioni):
${offer}

REGOLE OBBLIGATORIE:
1. Oggetto e oggetto alternativo: inizia SEMPRE con un'emoji pertinente + includi i dati concreti dell'offerta (prezzo esatto, % sconto, prodotto) + aggancio al topic creativo. Max 64 caratteri inclusa emoji.
2. CTA e CTA alternativa: TUTTO IN MAIUSCOLO.
3. Body landing page: testo lungo di circa 300 parole. Sviluppa il topic creativo in modo coinvolgente, poi presenta l'offerta con tutti i dati precisi. Usa paragrafi brevi, tono diretto.
4. Tutti i testi in ${lang}.

Rispondi SOLO con un oggetto JSON valido, senza markdown, senza backtick:

{
  "oggetto": "max 64 caratteri con emoji iniziale + dati offerta precisi + topic",
  "oggettoAlternativo": "max 64 caratteri con emoji iniziale + reminder offerta",
  "preview": "max 64 caratteri â€” richiamo evocativo al topic creativo",
  "previewAlternativa": "max 64 caratteri â€” richiamo all'offerta con dati precisi",
  "bodyEmail": "max 500 caratteri â€” sviluppo sintetico del topic, coinvolgente",
  "cta": "TUTTO MAIUSCOLO â€” CTA principale",
  "ctaAlternativa": "TUTTO MAIUSCOLO â€” CTA secondaria",
  "titoloLanding": "max 64 caratteri â€” titolo evocativo legato al topic",
  "bodyLanding": "circa 80 parole â€” testo persuasivo completo: apri con il topic creativo, sviluppalo emotivamente, poi presenta l'offerta con tutti i dati precisi (prodotto, prezzo, sconto, condizioni), chiudi con urgency"
}`;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 2500,
        messages: [{ role: 'user', content: prompt }]
      })
    });

    if (!resp.ok) {
      const err = await resp.json();
      throw new Error(err.error?.message || `Errore API: ${resp.status}`);
    }

    const data = await resp.json();
    const raw = data.content[0].text.trim();
    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('Risposta non valida dal modello.');

    const result = JSON.parse(jsonMatch[0]);

    // Enforce CTA uppercase
    if (result.cta) result.cta = result.cta.toUpperCase();
    if (result.ctaAlternativa) result.ctaAlternativa = result.ctaAlternativa.toUpperCase();

    renderResults(result);
  } catch(e) {
    showError(e.message);
  } finally {
    setLoading(false);
  }
}

function renderResults(data) {
  const grid = document.getElementById('resultsGrid');
  grid.innerHTML = '';

  for (const [sectionName, fields] of Object.entries(sectionGroups)) {
    const block = document.createElement('div');
    block.className = 'result-block';

    let html = `<div class="result-block-title">${sectionName}</div>`;

    for (const key of fields) {
      const value = data[key] || 'â€”';
      const limit = charLimits[key];
      const count = [...value].length; // unicode-aware count
      const over = limit && count > limit;
      const countHtml = limit ? `<span class="char-count${over ? ' over' : ''}">${count}/${limit}</span>` : '';

      // Safe data attribute for copy
      const dataVal = encodeURIComponent(value);

      html += `
        <div class="result-row">
          <div class="result-row-label">${fieldLabels[key] || key}</div>
          <div class="result-row-value">${escHtml(value)}${countHtml}</div>
          <button class="copy-btn" data-val="${dataVal}" onclick="copyText(this)">Copia</button>
        </div>`;
    }

    block.innerHTML = html;
    grid.appendChild(block);
  }

  document.getElementById('results').classList.add('visible');
  document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function escHtml(str) {
  return str
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}

async function copyText(btn) {
  try {
    const text = decodeURIComponent(btn.dataset.val);
    await navigator.clipboard.writeText(text);
    const orig = btn.textContent;
    btn.textContent = 'Copiato';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('copied'); }, 1500);
  } catch(e) {
    // fallback
    const text = decodeURIComponent(btn.dataset.val);
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    btn.textContent = 'Copiato';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copia'; btn.classList.remove('copied'); }, 1500);
  }
}

function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg;
  el.classList.add('visible');
}

function setLoading(on) {
  document.getElementById('generateBtn').disabled = on;
  document.getElementById('loading').classList.toggle('visible', on);
  if (on) {
    document.getElementById('results').classList.remove('visible');
    document.getElementById('errorMsg').classList.remove('visible');
  }
}
</script>
</body>
</html>
